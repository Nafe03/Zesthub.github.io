<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy RPG Adventure</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MedievalSharp', cursive;
            background: #000;
            color: white;
            overflow: hidden;
            user-select: none;
            height: 100vh;
        }

        /* Main Menu Styles */
        #mainMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80') no-repeat center center;
            background-size: cover;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        .menu-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: -1;
        }

        .game-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 3.5rem;
            color: #f8d347;
            text-shadow: 4px 4px 0 #8b4513, 6px 6px 0 #000;
            margin-bottom: 2rem;
            text-align: center;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #f8d347, 0 0 20px #f8d347;
            }
            to {
                text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #f8d347, 0 0 40px #f8d347;
            }
        }

        .menu-btn {
            background: linear-gradient(135deg, #8b4513, #a0522d);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            font-family: 'MedievalSharp', cursive;
            font-size: 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 0 #5a2d0c, 0 8px 10px rgba(0, 0, 0, 0.5);
            width: 250px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 0 #5a2d0c, 0 12px 15px rgba(0, 0, 0, 0.5);
        }

        .menu-btn:active {
            transform: translateY(2px);
            box-shadow: 0 3px 0 #5a2d0c, 0 5px 8px rgba(0, 0, 0, 0.5);
        }

        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .menu-btn:hover::before {
            left: 100%;
        }

        /* Login Screen */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .login-container {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 2rem;
            border-radius: 15px;
            border: 3px solid #8b4513;
            box-shadow: 0 0 20px rgba(139, 69, 19, 0.5);
            width: 400px;
            max-width: 90%;
        }

        .login-title {
            font-size: 2rem;
            color: #f8d347;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #f8d347;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #8b4513;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-family: 'MedievalSharp', cursive;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #f8d347;
            box-shadow: 0 0 10px rgba(248, 211, 71, 0.5);
        }

        .login-btn {
            background: linear-gradient(135deg, #8b4513, #a0522d);
            color: white;
            border: none;
            padding: 12px 25px;
            font-family: 'MedievalSharp', cursive;
            font-size: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 1rem;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #a0522d, #8b4513);
        }

        .back-btn {
            background: transparent;
            color: #f8d347;
            border: 2px solid #8b4513;
            padding: 8px 15px;
            margin-top: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 5px;
        }

        .back-btn:hover {
            background: rgba(139, 69, 19, 0.3);
        }

        /* Settings Screen */
        #settingsScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .settings-container {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 2rem;
            border-radius: 15px;
            border: 3px solid #8b4513;
            box-shadow: 0 0 20px rgba(139, 69, 19, 0.5);
            width: 500px;
            max-width: 90%;
        }

        .settings-title {
            font-size: 2rem;
            color: #f8d347;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .settings-group {
            margin-bottom: 1.5rem;
        }

        .settings-group h3 {
            color: #f8d347;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #8b4513;
            padding-bottom: 5px;
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        .settings-option label {
            color: white;
            font-size: 1.1rem;
        }

        .settings-option select, .settings-option input {
            padding: 8px;
            border-radius: 5px;
            border: 2px solid #8b4513;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-family: 'MedievalSharp', cursive;
        }

        .settings-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        /* Character Selection Screen */
        #characterScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .character-container {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 2rem;
            border-radius: 15px;
            border: 3px solid #8b4513;
            box-shadow: 0 0 20px rgba(139, 69, 19, 0.5);
            width: 800px;
            max-width: 90%;
        }

        .character-title {
            font-size: 2rem;
            color: #f8d347;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .character-options {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 2rem 0;
        }

        .character-option {
            width: 200px;
            margin: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid transparent;
        }

        .character-option:hover {
            transform: translateY(-5px);
            background: rgba(139, 69, 19, 0.3);
            border-color: #8b4513;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .character-option.selected {
            background: rgba(248, 211, 71, 0.2);
            border-color: #f8d347;
            box-shadow: 0 0 20px rgba(248, 211, 71, 0.5);
        }

        .character-img {
            width: 120px;
            height: 120px;
            margin: 0 auto 10px;
            background: #333;
            border-radius: 50%;
            border: 3px solid #8b4513;
            overflow: hidden;
            position: relative;
        }

        .character-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-name {
            font-size: 1.3rem;
            color: #f8d347;
            margin: 10px 0;
        }

        .character-desc {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 10px;
        }

        .character-stats {
            font-size: 0.8rem;
            color: #aaa;
            text-align: left;
            margin-top: 10px;
        }

        /* Game UI Styles */
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: none;
        }

        #gameCanvas {
            background: linear-gradient(45deg, #2d5016, #3d6b1a);
            border: 3px solid #8b4513;
            flex: 1;
            cursor: crosshair;
        }

        #ui {
            width: 280px;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
            border-left: 3px solid #8b4513;
            padding: 15px;
            overflow-y: auto;
            box-shadow: -5px 0 15px rgba(0,0,0,0.5);
        }

        .stat-bar {
            margin: 8px 0;
            position: relative;
            height: 25px;
            background: #333;
            border-radius: 12px;
            border: 2px solid #666;
            overflow: hidden;
        }

        .hp-bar { background: linear-gradient(90deg, #8b0000, #ff0000); }
        .mp-bar { background: linear-gradient(90deg, #000080, #4169e1); }
        .exp-bar { background: linear-gradient(90deg, #b8860b, #ffd700); }

        .stat-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            z-index: 2;
        }

        .inventory {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #666;
        }

        .inventory h3 {
            color: #ffd700;
            margin-bottom: 8px;
            text-align: center;
        }

        .item {
            background: rgba(255,255,255,0.1);
            margin: 3px 0;
            padding: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item:hover {
            background: rgba(255,215,0,0.2);
            border-color: #ffd700;
            transform: translateX(3px);
        }

        .item-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            background: #555;
            border-radius: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }

        .item-name {
            flex: 1;
        }

        .item-quantity {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
        }

        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            border: 2px solid #8b4513;
        }

        .minimap {
            position: absolute;
            top: 10px;
            right: 290px;
            width: 150px;
            height: 150px;
            background: rgba(0,0,0,0.8);
            border: 2px solid #666;
            border-radius: 8px;
        }

        .combat-ui {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #8b4513;
            display: none;
            min-width: 400px;
        }

        .combat-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .combat-btn {
            flex: 1;
            padding: 8px;
            background: linear-gradient(135deg, #4a4a4a, #666);
            border: 2px solid #888;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .combat-btn:hover {
            background: linear-gradient(135deg, #666, #888);
            border-color: #aaa;
            transform: translateY(-2px);
        }

        .message-log {
            height: 120px;
            overflow-y: auto;
            background: rgba(0,0,0,0.5);
            padding: 8px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #666;
            font-size: 11px;
            line-height: 1.3;
        }

        .message-log::-webkit-scrollbar {
            width: 8px;
        }

        .message-log::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        .message-log::-webkit-scrollbar-thumb {
            background: #8b4513;
            border-radius: 4px;
        }

        .damage-text {
            position: absolute;
            color: #ff4444;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 2px 2px 4px black;
            pointer-events: none;
            z-index: 1000;
        }

        .heal-text {
            position: absolute;
            color: #44ff44;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 2px 2px 4px black;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes fadeUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }

        .fade-up {
            animation: fadeUp 1.5s ease-out forwards;
        }

        .level-up {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #000;
            padding: 20px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            border: 3px solid #b8860b;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            z-index: 2000;
            display: none;
        }

        .quest-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ffd700;
            border-radius: 50%;
            border: 2px solid #b8860b;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* Shop UI */
        #shopUI {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #8b4513;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        #shopUI h2 {
            color: #f8d347;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #8b4513;
            padding-bottom: 10px;
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #666;
            transition: all 0.2s;
            cursor: pointer;
        }

        .shop-item:hover {
            background: rgba(139, 69, 19, 0.3);
            border-color: #8b4513;
            transform: translateY(-3px);
        }

        .shop-item-img {
            width: 100%;
            height: 100px;
            background: #333;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
        }

        .shop-item-name {
            font-weight: bold;
            color: #f8d347;
            margin-bottom: 5px;
        }

        .shop-item-price {
            color: #ffd700;
            font-size: 0.9rem;
        }

        .shop-item-desc {
            font-size: 0.8rem;
            color: #aaa;
            margin: 5px 0;
        }

        .shop-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .shop-btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-family: 'MedievalSharp', cursive;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .buy-btn {
            background: linear-gradient(135deg, #8b4513, #a0522d);
            color: white;
        }

        .buy-btn:hover {
            background: linear-gradient(135deg, #a0522d, #8b4513);
        }

        .close-shop {
            background: transparent;
            border: 1px solid #8b4513;
            color: #f8d347;
        }

        .close-shop:hover {
            background: rgba(139, 69, 19, 0.3);
        }

        /* Quest UI */
        #questUI {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #8b4513;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        #questUI h2 {
            color: #f8d347;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #8b4513;
            padding-bottom: 10px;
        }

        .quest-list {
            margin-bottom: 20px;
        }

        .quest-item {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #666;
        }

        .quest-item.active {
            border-color: #f8d347;
            background: rgba(248, 211, 71, 0.1);
        }

        .quest-item.completed {
            border-color: #44ff44;
            background: rgba(68, 255, 68, 0.1);
        }

        .quest-title {
            font-weight: bold;
            color: #f8d347;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .quest-status {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .quest-status.active {
            background: #f8d347;
            color: #000;
        }

        .quest-status.completed {
            background: #44ff44;
            color: #000;
        }

        .quest-desc {
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .quest-progress {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .quest-reward {
            font-size: 0.8rem;
            color: #ffd700;
        }

        .quest-actions {
            text-align: right;
            margin-top: 20px;
        }

        /* Game Over Screen */
        #gameOverScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1002;
        }

        .game-over-container {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 2rem;
            border-radius: 15px;
            border: 3px solid #8b4513;
            box-shadow: 0 0 20px rgba(139, 69, 19, 0.5);
            width: 500px;
            max-width: 90%;
            text-align: center;
        }

        .game-over-title {
            font-size: 2.5rem;
            color: #ff4444;
            margin-bottom: 1rem;
        }

        .game-over-stats {
            margin: 1.5rem 0;
            text-align: left;
        }

        .game-over-stat {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .game-over-stat-label {
            color: #f8d347;
        }

        .game-over-actions {
            margin-top: 2rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .menu-btn {
                width: 200px;
                padding: 12px 20px;
                font-size: 1.2rem;
            }
            
            #ui {
                width: 220px;
                font-size: 0.9rem;
            }
            
            .minimap {
                width: 100px;
                height: 100px;
                right: 230px;
            }
            
            .combat-ui {
                min-width: 300px;
                padding: 10px;
            }
            
            .combat-actions {
                flex-wrap: wrap;
            }
            
            .combat-btn {
                min-width: 120px;
                margin: 3px;
            }
        }
    </style>
</head>
<body>
    <!-- Main Menu Screen -->
    <div id="mainMenu">
        <div class="menu-overlay"></div>
        <h1 class="game-title">Fantasy RPG</h1>
        <button class="menu-btn" id="playBtn">Play Game</button>
        <button class="menu-btn" id="settingsBtn">Settings</button>
        <button class="menu-btn" id="creditsBtn">Credits</button>
        <button class="menu-btn" id="exitBtn">Exit</button>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h2 class="login-title">Adventurer's Log</h2>
            <div class="form-group">
                <label for="username">Your Name:</label>
                <input type="text" id="username" class="form-control" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label for="password">Secret Code:</label>
                <input type="password" id="password" class="form-control" placeholder="Optional password">
            </div>
            <button class="login-btn" id="loginBtn">Begin Adventure</button>
            <button class="back-btn" id="backToMenuBtn">Back to Menu</button>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="settingsScreen">
        <div class="settings-container">
            <h2 class="settings-title">Game Settings</h2>
            
            <div class="settings-group">
                <h3>Graphics</h3>
                <div class="settings-option">
                    <label for="graphicsQuality">Quality:</label>
                    <select id="graphicsQuality">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="settings-option">
                    <label for="showEffects">Show Effects:</label>
                    <input type="checkbox" id="showEffects" checked>
                </div>
            </div>
            
            <div class="settings-group">
                <h3>Audio</h3>
                <div class="settings-option">
                    <label for="musicVolume">Music Volume:</label>
                    <input type="range" id="musicVolume" min="0" max="100" value="70">
                </div>
                <div class="settings-option">
                    <label for="sfxVolume">SFX Volume:</label>
                    <input type="range" id="sfxVolume" min="0" max="100" value="80">
                </div>
            </div>
            
            <div class="settings-group">
                <h3>Controls</h3>
                <div class="settings-option">
                    <label for="keyboardLayout">Keyboard Layout:</label>
                    <select id="keyboardLayout">
                        <option value="wasd">WASD</option>
                        <option value="arrows">Arrow Keys</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-actions">
                <button class="menu-btn" id="saveSettingsBtn">Save Settings</button>
                <button class="back-btn" id="backToMenuFromSettingsBtn">Back to Menu</button>
            </div>
        </div>
    </div>

    <!-- Character Selection Screen -->
    <div id="characterScreen">
        <div class="character-container">
            <h2 class="character-title">Choose Your Hero</h2>
            
            <div class="character-options">
                <div class="character-option" data-class="warrior">
                    <div class="character-img">
                        <span>⚔️</span>
                    </div>
                    <h3 class="character-name">Warrior</h3>
                    <p class="character-desc">A strong melee fighter with high health and attack.</p>
                    <div class="character-stats">
                        <div>HP: ★★★★★</div>
                        <div>ATK: ★★★★☆</div>
                        <div>DEF: ★★★☆☆</div>
                        <div>SPD: ★★☆☆☆</div>
                    </div>
                </div>
                
                <div class="character-option" data-class="ranger">
                    <div class="character-img">
                        <span>🏹</span>
                    </div>
                    <h3 class="character-name">Ranger</h3>
                    <p class="character-desc">A nimble ranged fighter with balanced stats.</p>
                    <div class="character-stats">
                        <div>HP: ★★★☆☆</div>
                        <div>ATK: ★★★★☆</div>
                        <div>DEF: ★★★☆☆</div>
                        <div>SPD: ★★★★☆</div>
                    </div>
                </div>
                
                <div class="character-option" data-class="mage">
                    <div class="character-img">
                        <span>🔮</span>
                    </div>
                    <h3 class="character-name">Mage</h3>
                    <p class="character-desc">A powerful spellcaster with strong magic attacks.</p>
                    <div class="character-stats">
                        <div>HP: ★★☆☆☆</div>
                        <div>ATK: ★★★★★</div>
                        <div>DEF: ★★☆☆☆</div>
                        <div>SPD: ★★★☆☆</div>
                    </div>
                </div>
                
                <div class="character-option" data-class="rogue">
                    <div class="character-img">
                        <span>🗡️</span>
                    </div>
                    <h3 class="character-name">Rogue</h3>
                    <p class="character-desc">A stealthy fighter with high critical hits.</p>
                    <div class="character-stats">
                        <div>HP: ★★★☆☆</div>
                        <div>ATK: ★★★★☆</div>
                        <div>DEF: ★★☆☆☆</div>
                        <div>SPD: ★★★★★</div>
                    </div>
                </div>
            </div>
            
            <div class="character-actions">
                <button class="menu-btn" id="selectCharacterBtn">Select Hero</button>
                <button class="back-btn" id="backToLoginBtn">Back</button>
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer">
        <canvas id="gameCanvas" width="1200" height="800"></canvas>
        
        <div class="controls">
            <div><strong>🎮 Controls:</strong></div>
            <div>WASD / Arrow Keys - Move</div>
            <div>Space - Attack nearby enemy</div>
            <div>E - Interact/Open Chest</div>
            <div>I - Use potion</div>
            <div>M - Toggle minimap</div>
            <div>Q - Open Quests</div>
            <div>P - Open Shop</div>
        </div>

        <canvas id="minimap" class="minimap" width="150" height="150"></canvas>

        <div id="ui">
            <div style="text-align: center; margin-bottom: 15px;">
                <h2 id="playerName">Hero</h2>
                <div>Level <span id="playerLevel">1</span> <span id="playerClass"></span></div>
                <div>💰 <span id="playerGold">50</span> Gold</div>
            </div>

            <div class="stat-bar">
                <div id="hpBar" class="hp-bar" style="width: 100%;"></div>
                <div class="stat-text" id="hpText">100/100 HP</div>
            </div>

            <div class="stat-bar">
                <div id="mpBar" class="mp-bar" style="width: 100%;"></div>
                <div class="stat-text" id="mpText">50/50 MP</div>
            </div>

            <div class="stat-bar">
                <div id="expBar" class="exp-bar" style="width: 0%;"></div>
                <div class="stat-text" id="expText">0/100 EXP</div>
            </div>

            <div class="inventory">
                <h3>⚔️ Equipment</h3>
                <div>Weapon: <span id="weaponName">Rusty Sword</span></div>
                <div>Armor: <span id="armorName">Cloth Shirt</span></div>
                <div>Attack: <span id="attackStat">20</span></div>
                <div>Defense: <span id="defenseStat">10</span></div>
            </div>

            <div class="inventory">
                <h3>🎒 Inventory</h3>
                <div id="inventoryList"></div>
            </div>

            <div class="message-log" id="messageLog"></div>

            <div style="text-align: center; margin-top: 10px;">
                <div><strong>📍 Current Area:</strong></div>
                <div id="currentArea">Forest Outskirts</div>
            </div>
        </div>

        <!-- Combat UI -->
        <div id="combatUI" class="combat-ui">
            <div><strong>⚔️ Combat!</strong></div>
            <div>Enemy: <span id="enemyName"></span></div>
            <div>Enemy HP: <span id="enemyHP"></span></div>
            <div class="combat-actions">
                <button class="combat-btn" onclick="combatAction('attack')">⚔️ Attack</button>
                <button class="combat-btn" onclick="combatAction('magic')">✨ Magic</button>
                <button class="combat-btn" onclick="combatAction('item')">🧪 Potion</button>
                <button class="combat-btn" onclick="combatAction('flee')">🏃 Flee</button>
            </div>
        </div>

        <!-- Level Up Notification -->
        <div id="levelUpNotification" class="level-up">
            <div>🎉 LEVEL UP! 🎉</div>
            <div id="levelUpText"></div>
        </div>

        <!-- Shop UI -->
        <div id="shopUI">
            <h2>Blacksmith's Shop</h2>
            <div class="shop-items" id="shopItems">
                <!-- Items will be added dynamically -->
            </div>
            <div class="shop-actions">
                <button class="shop-btn buy-btn" id="buyItemBtn">Buy Selected</button>
                <button class="shop-btn close-shop" id="closeShopBtn">Leave Shop</button>
            </div>
        </div>

        <!-- Quest UI -->
        <div id="questUI">
            <h2>Quest Journal</h2>
            <div class="quest-list" id="questList">
                <!-- Quests will be added dynamically -->
            </div>
            <div class="quest-actions">
                <button class="shop-btn close-shop" id="closeQuestBtn">Close Journal</button>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen">
        <div class="game-over-container">
            <h2 class="game-over-title">GAME OVER</h2>
            <p>Your adventure has come to an end...</p>
            
            <div class="game-over-stats">
                <div class="game-over-stat">
                    <span class="game-over-stat-label">Level Reached:</span>
                    <span id="goLevel">1</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">Gold Collected:</span>
                    <span id="goGold">0</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">Enemies Defeated:</span>
                    <span id="goEnemies">0</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">Quests Completed:</span>
                    <span id="goQuests">0</span>
                </div>
            </div>
            
            <div class="game-over-actions">
                <button class="menu-btn" id="restartGameBtn">Start New Game</button>
                <button class="back-btn" id="returnToMenuBtn">Return to Menu</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        const game = {
            canvas: document.getElementById('gameCanvas'),
            ctx: null,
            minimapCanvas: document.getElementById('minimap'),
            minimapCtx: null,
            running: true,
            lastTime: 0,
            camera: { x: 0, y: 0 },
            showMinimap: true,
            paused: false,
            settings: {
                graphicsQuality: 'medium',
                showEffects: true,
                musicVolume: 70,
                sfxVolume: 80,
                keyboardLayout: 'wasd'
            },
            playerName: 'Adventurer',
            playerClass: 'warrior',
            gameTime: 0,
            enemiesDefeated: 0,
            questsCompleted: 0
        };

        // Player object
        const player = {
            x: 400,
            y: 300,
            width: 30,
            height: 30,
            speed: 3,
            color: '#4a90e2',
            hp: 100,
            maxHp: 100,
            mp: 50,
            maxMp: 50,
            level: 1,
            exp: 0,
            expToNext: 100,
            gold: 50,
            attack: 20,
            defense: 10,
            weapon: 'Rusty Sword',
            armor: 'Cloth Shirt',
            inventory: {
                'Health Potion': 3,
                'Mana Potion': 2
            },
            lastAttack: 0,
            inCombat: false,
            combatTarget: null,
            quests: []
        };

        // Character classes
        const characterClasses = {
            warrior: {
                name: 'Warrior',
                stats: {
                    hp: 120,
                    maxHp: 120,
                    mp: 30,
                    maxMp: 30,
                    attack: 25,
                    defense: 15,
                    speed: 2.8
                },
                abilities: ['Berserk Rage', 'Shield Bash'],
                color: '#8B0000'
            },
            ranger: {
                name: 'Ranger',
                stats: {
                    hp: 90,
                    maxHp: 90,
                    mp: 50,
                    maxMp: 50,
                    attack: 22,
                    defense: 10,
                    speed: 3.5
                },
                abilities: ['Double Shot', 'Poison Arrow'],
                color: '#556B2F'
            },
            mage: {
                name: 'Mage',
                stats: {
                    hp: 70,
                    maxHp: 70,
                    mp: 80,
                    maxMp: 80,
                    attack: 30,
                    defense: 5,
                    speed: 3.0
                },
                abilities: ['Fireball', 'Ice Nova'],
                color: '#4169E1'
            },
            rogue: {
                name: 'Rogue',
                stats: {
                    hp: 85,
                    maxHp: 85,
                    mp: 40,
                    maxMp: 40,
                    attack: 24,
                    defense: 8,
                    speed: 4.0
                },
                abilities: ['Backstab', 'Smoke Bomb'],
                color: '#4B0082'
            }
        };

        // Input handling
        const keys = {};
        const mouse = { x: 0, y: 0, clicked: false };

        // World data
        const world = {
            width: 2000,
            height: 1500,
            trees: [],
            rocks: [],
            enemies: [],
            items: [],
            chests: [],
            npcs: [],
            shops: [],
            areas: {
                'Forest Outskirts': { x: 0, y: 0, width: 800, height: 600 },
                'Dark Woods': { x: 800, y: 0, width: 600, height: 800 },
                'Ancient Cave': { x: 0, y: 600, width: 700, height: 500 },
                'Mystic Valley': { x: 1400, y: 400, width: 600, height: 700 }
            },
            currentArea: 'Forest Outskirts'
        };

        // Enemy types
        const enemyTypes = {
            goblin: {
                name: 'Goblin',
                hp: 40,
                attack: 15,
                defense: 5,
                exp: 25,
                gold: 15,
                color: '#8B4513',
                speed: 1.5
            },
            wolf: {
                name: 'Wolf',
                hp: 50,
                attack: 18,
                defense: 8,
                exp: 30,
                gold: 20,
                color: '#696969',
                speed: 2
            },
            orc: {
                name: 'Orc',
                hp: 80,
                attack: 25,
                defense: 12,
                exp: 50,
                gold: 35,
                color: '#556B2F',
                speed: 1
            },
            skeleton: {
                name: 'Skeleton',
                hp: 60,
                attack: 20,
                defense: 10,
                exp: 40,
                gold: 25,
                color: '#D3D3D3',
                speed: 1.8
            }
        };

        // Weapons and armor
        const weapons = {
            'Rusty Sword': { attack: 5, price: 0 },
            'Iron Sword': { attack: 10, price: 50 },
            'Steel Sword': { attack: 15, price: 120 },
            'Silver Sword': { attack: 20, price: 250 },
            'Dragon Slayer': { attack: 30, price: 500 },
            'Wooden Bow': { attack: 8, price: 40 },
            'Longbow': { attack: 14, price: 100 },
            'Elven Bow': { attack: 22, price: 300 },
            'Oak Staff': { attack: 12, price: 60 },
            'Wizard Staff': { attack: 18, price: 180 },
            'Staff of Power': { attack: 25, price: 400 }
        };

        const armor = {
            'Cloth Shirt': { defense: 2, price: 0 },
            'Leather Armor': { defense: 5, price: 40 },
            'Chainmail': { defense: 10, price: 100 },
            'Plate Armor': { defense: 15, price: 200 },
            'Dragon Armor': { defense: 25, price: 450 },
            'Rogue Cloak': { defense: 8, price: 80 },
            'Mage Robe': { defense: 6, price: 60 }
        };

        // Quests
        const quests = {
            'First Steps': {
                description: 'Defeat 5 enemies to prove your worth.',
                objective: { type: 'kill', target: 'any', amount: 5 },
                reward: { gold: 50, exp: 100, item: 'Iron Sword' },
                completed: false,
                progress: 0
            },
            'Goblin Menace': {
                description: 'Clear out the goblins in the Forest Outskirts.',
                objective: { type: 'kill', target: 'goblin', amount: 3 },
                reward: { gold: 30, exp: 75, item: 'Health Potion' },
                completed: false,
                progress: 0
            },
            'Treasure Hunter': {
                description: 'Find and open 3 treasure chests.',
                objective: { type: 'chest', amount: 3 },
                reward: { gold: 100, exp: 50 },
                completed: false,
                progress: 0
            },
            'Weapon Upgrade': {
                description: 'Purchase your first weapon upgrade from the blacksmith.',
                objective: { type: 'buy', itemType: 'weapon' },
                reward: { gold: 20, exp: 30 },
                completed: false,
                progress: 0
            }
        };

        // Initialize canvas contexts
        game.ctx = game.canvas.getContext('2d');
        game.minimapCtx = game.minimapCanvas.getContext('2d');

        // Menu event listeners
        document.getElementById('playBtn').addEventListener('click', () => {
            document.getElementById('mainMenu').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
            }, 500);
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('mainMenu').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('settingsScreen').style.display = 'flex';
                loadSettings();
            }, 500);
        });

        document.getElementById('creditsBtn').addEventListener('click', () => {
            alert('Fantasy RPG Adventure\nCreated by [Your Name]\n\nArt assets from:\n- OpenGameArt.org\n- Unsplash.com\n\nMusic from:\n- Incompetech.com\n\nSpecial thanks to all playtesters!');
        });

        document.getElementById('exitBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to exit the game?')) {
                window.close();
            }
        });

        // Login screen events
        document.getElementById('loginBtn').addEventListener('click', () => {
            const username = document.getElementById('username').value.trim();
            if (username) {
                game.playerName = username;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('characterScreen').style.display = 'flex';
            } else {
                alert('Please enter your name to begin!');
            }
        });

        document.getElementById('backToMenuBtn').addEventListener('click', () => {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('mainMenu').style.opacity = '1';
            }, 10);
        });

        // Character selection events
        const characterOptions = document.querySelectorAll('.character-option');
        characterOptions.forEach(option => {
            option.addEventListener('click', function() {
                characterOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                game.playerClass = this.getAttribute('data-class');
            });
        });

        // Select first character by default
        characterOptions[0].classList.add('selected');
        game.playerClass = characterOptions[0].getAttribute('data-class');

        document.getElementById('selectCharacterBtn').addEventListener('click', () => {
            document.getElementById('characterScreen').style.display = 'none';
            startGame();
        });

        document.getElementById('backToLoginBtn').addEventListener('click', () => {
            document.getElementById('characterScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        });

        // Settings screen events
        function loadSettings() {
            const savedSettings = localStorage.getItem('gameSettings');
            if (savedSettings) {
                game.settings = JSON.parse(savedSettings);
            }
            
            document.getElementById('graphicsQuality').value = game.settings.graphicsQuality;
            document.getElementById('showEffects').checked = game.settings.showEffects;
            document.getElementById('musicVolume').value = game.settings.musicVolume;
            document.getElementById('sfxVolume').value = game.settings.sfxVolume;
            document.getElementById('keyboardLayout').value = game.settings.keyboardLayout;
        }

        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            game.settings.graphicsQuality = document.getElementById('graphicsQuality').value;
            game.settings.showEffects = document.getElementById('showEffects').checked;
            game.settings.musicVolume = document.getElementById('musicVolume').value;
            game.settings.sfxVolume = document.getElementById('sfxVolume').value;
            game.settings.keyboardLayout = document.getElementById('keyboardLayout').value;
            
            localStorage.setItem('gameSettings', JSON.stringify(game.settings));
            
            alert('Settings saved successfully!');
        });

        document.getElementById('backToMenuFromSettingsBtn').addEventListener('click', () => {
            document.getElementById('settingsScreen').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('mainMenu').style.opacity = '1';
            }, 10);
        });

        // Game over screen events
        document.getElementById('restartGameBtn').addEventListener('click', () => {
            document.getElementById('gameOverScreen').style.display = 'none';
            resetGame();
            startGame();
        });

        document.getElementById('returnToMenuBtn').addEventListener('click', () => {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('mainMenu').style.opacity = '1';
            }, 10);
        });

        // Shop UI events
        document.getElementById('closeShopBtn').addEventListener('click', () => {
            document.getElementById('shopUI').style.display = 'none';
            game.paused = false;
        });

        // Quest UI events
        document.getElementById('closeQuestBtn').addEventListener('click', () => {
            document.getElementById('questUI').style.display = 'none';
            game.paused = false;
        });

        // Initialize game world
        function initWorld() {
            // Generate trees
            for (let i = 0; i < 150; i++) {
                world.trees.push({
                    x: Math.random() * world.width,
                    y: Math.random() * world.height,
                    size: 20 + Math.random() * 30
                });
            }

            // Generate rocks
            for (let i = 0; i < 80; i++) {
                world.rocks.push({
                    x: Math.random() * world.width,
                    y: Math.random() * world.height,
                    size: 15 + Math.random() * 25
                });
            }

            // Generate chests
            for (let i = 0; i < 10; i++) {
                world.chests.push({
                    x: Math.random() * world.width,
                    y: Math.random() * world.height,
                    opened: false,
                    items: [
                        Math.random() > 0.7 ? 'Health Potion' : 'Mana Potion',
                        Math.random() > 0.8 ? 'Iron Sword' : null,
                        Math.random() > 0.9 ? 'Leather Armor' : null
                    ].filter(Boolean),
                    gold: 10 + Math.floor(Math.random() * 40)
                });
            }

            // Generate shops
            world.shops.push({
                x: 500,
                y: 400,
                width: 40,
                height: 40,
                type: 'blacksmith'
            });

            // Generate enemies
            generateEnemies();

            // Generate items
            for (let i = 0; i < 20; i++) {
                world.items.push({
                    x: Math.random() * world.width,
                    y: Math.random() * world.height,
                    type: Math.random() > 0.5 ? 'gold' : 'potion',
                    collected: false
                });
            }

            // Initialize quests
            for (const [id, quest] of Object.entries(quests)) {
                player.quests.push({ id, ...quest });
            }
        }

        function generateEnemies() {
            world.enemies = [];
            const enemyCount = 30;
            
            for (let i = 0; i < enemyCount; i++) {
                const types = Object.keys(enemyTypes);
                const type = types[Math.floor(Math.random() * types.length)];
                const enemyData = enemyTypes[type];
                
                world.enemies.push({
                    x: Math.random() * world.width,
                    y: Math.random() * world.height,
                    width: 25,
                    height: 25,
                    type: type,
                    name: enemyData.name,
                    hp: enemyData.hp,
                    maxHp: enemyData.hp,
                    attack: enemyData.attack,
                    defense: enemyData.defense,
                    exp: enemyData.exp,
                    gold: enemyData.gold,
                    color: enemyData.color,
                    speed: enemyData.speed,
                    lastMove: 0,
                    direction: Math.random() * Math.PI * 2,
                    alive: true,
                    chasing: false
                });
            }
        }

        // Event listeners
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            
            if (e.key.toLowerCase() === 'i') {
                usePotion('Health Potion');
            } else if (e.key.toLowerCase() === 'm') {
                game.showMinimap = !game.showMinimap;
                game.minimapCanvas.style.display = game.showMinimap ? 'block' : 'none';
            } else if (e.key === ' ') {
                e.preventDefault();
                attackNearbyEnemy();
            } else if (e.key.toLowerCase() === 'q' && !player.inCombat) {
                toggleQuestUI();
            } else if (e.key.toLowerCase() === 'p' && !player.inCombat) {
                toggleShopUI();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        game.canvas.addEventListener('mousemove', (e) => {
            const rect = game.canvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
        });

        game.canvas.addEventListener('click', (e) => {
            if (!player.inCombat && !game.paused) {
                const worldX = mouse.x + game.camera.x;
                const worldY = mouse.y + game.camera.y;
                
                // Check if clicking on enemy
                world.enemies.forEach(enemy => {
                    if (enemy.alive && 
                        worldX >= enemy.x && worldX <= enemy.x + enemy.width &&
                        worldY >= enemy.y && worldY <= enemy.y + enemy.height) {
                        startCombat(enemy);
                    }
                });
                
                // Check if clicking on chest
                world.chests.forEach(chest => {
                    if (!chest.opened && 
                        worldX >= chest.x && worldX <= chest.x + 30 &&
                        worldY >= chest.y && worldY <= chest.y + 30) {
                        openChest(chest);
                    }
                });
                
                // Check if clicking on shop
                world.shops.forEach(shop => {
                    if (worldX >= shop.x && worldX <= shop.x + shop.width &&
                        worldY >= shop.y && worldY <= shop.y + shop.height) {
                        toggleShopUI();
                    }
                });
            }
        });

        // Game logic functions
        function updatePlayer(deltaTime) {
            if (player.inCombat || game.paused) return;

            let dx = 0, dy = 0;

            // Handle movement based on keyboard layout setting
            if (game.settings.keyboardLayout === 'wasd') {
                if (keys['w'] || keys['arrowup']) dy -= player.speed;
                if (keys['s'] || keys['arrowdown']) dy += player.speed;
                if (keys['a'] || keys['arrowleft']) dx -= player.speed;
                if (keys['d'] || keys['arrowright']) dx += player.speed;
            } else {
                if (keys['arrowup']) dy -= player.speed;
                if (keys['arrowdown']) dy += player.speed;
                if (keys['arrowleft']) dx -= player.speed;
                if (keys['arrowright']) dx += player.speed;
            }

            // Diagonal movement normalization
            if (dx !== 0 && dy !== 0) {
                dx *= 0.707;
                dy *= 0.707;
            }

            // Check collisions before moving
            const newX = player.x + dx;
            const newY = player.y + dy;

            if (newX >= 0 && newX <= world.width - player.width) {
                if (!checkCollision(newX, player.y, player.width, player.height)) {
                    player.x = newX;
                }
            }

            if (newY >= 0 && newY <= world.height - player.height) {
                if (!checkCollision(player.x, newY, player.width, player.height)) {
                    player.y = newY;
                }
            }

            // Update camera
            game.camera.x = player.x - game.canvas.width / 2;
            game.camera.y = player.y - game.canvas.height / 2;

            // Clamp camera to world bounds
            game.camera.x = Math.max(0, Math.min(world.width - game.canvas.width, game.camera.x));
            game.camera.y = Math.max(0, Math.min(world.height - game.canvas.height, game.camera.y));

            // Check area
            updateCurrentArea();

            // Collect items
            collectItems();
            
            // Check for nearby chests or shops
            checkInteractables();
            
            // Update game time
            game.gameTime += deltaTime;
        }

        function updateEnemies(deltaTime) {
            world.enemies.forEach(enemy => {
                if (!enemy.alive || player.inCombat || game.paused) return;

                const distToPlayer = Math.sqrt(
                    Math.pow(enemy.x - player.x, 2) + Math.pow(enemy.y - player.y, 2)
                );

                if (distToPlayer < 100) {
                    // Chase player
                    enemy.chasing = true;
                    const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                    enemy.x += Math.cos(angle) * enemy.speed;
                    enemy.y += Math.sin(angle) * enemy.speed;

                    // Start combat if close enough
                    if (distToPlayer < 35) {
                        startCombat(enemy);
                    }
                } else {
                    // Random movement
                    enemy.chasing = false;
                    if (Date.now() - enemy.lastMove > 2000) {
                        enemy.direction = Math.random() * Math.PI * 2;
                        enemy.lastMove = Date.now();
                    }

                    const moveX = Math.cos(enemy.direction) * enemy.speed * 0.5;
                    const moveY = Math.sin(enemy.direction) * enemy.speed * 0.5;

                    if (enemy.x + moveX >= 0 && enemy.x + moveX <= world.width - enemy.width) {
                        enemy.x += moveX;
                    }
                    if (enemy.y + moveY >= 0 && enemy.y + moveY <= world.height - enemy.height) {
                        enemy.y += moveY;
                    }
                }
            });
        }

        function checkCollision(x, y, width, height) {
            // Check tree collisions
            for (let tree of world.trees) {
                if (x < tree.x + tree.size && x + width > tree.x &&
                    y < tree.y + tree.size && y + height > tree.y) {
                    return true;
                }
            }

            // Check rock collisions
            for (let rock of world.rocks) {
                if (x < rock.x + rock.size && x + width > rock.x &&
                    y < rock.y + rock.size && y + height > rock.y) {
                    return true;
                }
            }
            
            // Check chest collisions
            for (let chest of world.chests) {
                if (!chest.opened && 
                    x < chest.x + 30 && x + width > chest.x &&
                    y < chest.y + 30 && y + height > chest.y) {
                    return true;
                }
            }
            
            // Check shop collisions
            for (let shop of world.shops) {
                if (x < shop.x + shop.width && x + width > shop.x &&
                    y < shop.y + shop.height && y + height > shop.y) {
                    return true;
                }
            }

            return false;
        }

        function updateCurrentArea() {
            for (let [areaName, area] of Object.entries(world.areas)) {
                if (player.x >= area.x && player.x < area.x + area.width &&
                    player.y >= area.y && player.y < area.y + area.height) {
                    if (world.currentArea !== areaName) {
                        world.currentArea = areaName;
                        addMessage(`📍 Entered ${areaName}`);
                        document.getElementById('currentArea').textContent = areaName;
                    }
                    break;
                }
            }
        }

        function collectItems() {
            world.items.forEach(item => {
                if (!item.collected && 
                    Math.abs(item.x - player.x) < 30 && 
                    Math.abs(item.y - player.y) < 30) {
                    
                    item.collected = true;
                    
                    if (item.type === 'gold') {
                        const goldAmount = 10 + Math.floor(Math.random() * 20);
                        player.gold += goldAmount;
                        addMessage(`💰 Found ${goldAmount} gold!`);
                        showFloatingText(item.x, item.y, `+${goldAmount}g`, '#ffd700');
                    } else if (item.type === 'potion') {
                        const potionType = Math.random() > 0.5 ? 'Health Potion' : 'Mana Potion';
                        if (!player.inventory[potionType]) player.inventory[potionType] = 0;
                        player.inventory[potionType]++;
                        addMessage(`🧪 Found ${potionType}!`);
                        showFloatingText(item.x, item.y, `+${potionType}`, '#44ff44');
                    }
                    
                    updateUI();
                }
            });
        }
        
        function checkInteractables() {
            // Check if E key is pressed for interaction
            if (keys['e'] && Date.now() - player.lastAttack > 300) {
                player.lastAttack = Date.now();
                
                // Check for nearby chests
                world.chests.forEach(chest => {
                    if (!chest.opened && 
                        Math.abs(chest.x - player.x) < 50 && 
                        Math.abs(chest.y - player.y) < 50) {
                        openChest(chest);
                    }
                });
                
                // Check for nearby shops
                world.shops.forEach(shop => {
                    if (Math.abs(shop.x + shop.width/2 - player.x) < 60 && 
                        Math.abs(shop.y + shop.height/2 - player.y) < 60) {
                        toggleShopUI();
                    }
                });
            }
        }
        
        function openChest(chest) {
            if (chest.opened) return;
            
            chest.opened = true;
            player.gold += chest.gold;
            
            let itemsFound = [];
            chest.items.forEach(item => {
                if (!player.inventory[item]) player.inventory[item] = 0;
                player.inventory[item]++;
                itemsFound.push(item);
            });
            
            addMessage(`🗃️ Opened a treasure chest! Found ${chest.gold} gold${itemsFound.length ? ' and ' + itemsFound.join(', ') : ''}`);
            showFloatingText(chest.x, chest.y, `Treasure!`, '#ffd700');
            
            // Update quest progress
            updateQuestProgress('chest');
            
            updateUI();
        }
        
        function toggleShopUI() {
            if (game.paused && document.getElementById('shopUI').style.display === 'block') {
                document.getElementById('shopUI').style.display = 'none';
                game.paused = false;
                return;
            }
            
            game.paused = true;
            document.getElementById('shopUI').style.display = 'block';
            
            // Populate shop items
            const shopItemsContainer = document.getElementById('shopItems');
            shopItemsContainer.innerHTML = '';
            
            // Add weapons to shop
            Object.entries(weapons).forEach(([name, data]) => {
                if (name !== player.weapon && name !== 'Rusty Sword') {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shop-item';
                    itemDiv.dataset.type = 'weapon';
                    itemDiv.dataset.name = name;
                    itemDiv.dataset.price = data.price;
                    itemDiv.innerHTML = `
                        <div class="shop-item-img">⚔️</div>
                        <div class="shop-item-name">${name}</div>
                        <div class="shop-item-price">${data.price} gold</div>
                        <div class="shop-item-desc">Attack +${data.attack}</div>
                    `;
                    itemDiv.addEventListener('click', function() {
                        document.querySelectorAll('.shop-item').forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                    shopItemsContainer.appendChild(itemDiv);
                }
            });
            
            // Add armor to shop
            Object.entries(armor).forEach(([name, data]) => {
                if (name !== player.armor && name !== 'Cloth Shirt') {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shop-item';
                    itemDiv.dataset.type = 'armor';
                    itemDiv.dataset.name = name;
                    itemDiv.dataset.price = data.price;
                    itemDiv.innerHTML = `
                        <div class="shop-item-img">🛡️</div>
                        <div class="shop-item-name">${name}</div>
                        <div class="shop-item-price">${data.price} gold</div>
                        <div class="shop-item-desc">Defense +${data.defense}</div>
                    `;
                    itemDiv.addEventListener('click', function() {
                        document.querySelectorAll('.shop-item').forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                    shopItemsContainer.appendChild(itemDiv);
                }
            });
            
            // Add potions to shop
            const potions = [
                { name: 'Health Potion', price: 20, desc: 'Restores 30-50 HP' },
                { name: 'Mana Potion', price: 25, desc: 'Restores 20-35 MP' }
            ];
            
            potions.forEach(potion => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.dataset.type = 'potion';
                itemDiv.dataset.name = potion.name;
                itemDiv.dataset.price = potion.price;
                itemDiv.innerHTML = `
                    <div class="shop-item-img">🧪</div>
                    <div class="shop-item-name">${potion.name}</div>
                    <div class="shop-item-price">${potion.price} gold</div>
                    <div class="shop-item-desc">${potion.desc}</div>
                `;
                itemDiv.addEventListener('click', function() {
                    document.querySelectorAll('.shop-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                });
                shopItemsContainer.appendChild(itemDiv);
            });
            
            // Set up buy button
            document.getElementById('buyItemBtn').onclick = function() {
                const selected = document.querySelector('.shop-item.selected');
                if (!selected) {
                    addMessage('❌ Please select an item to purchase');
                    return;
                }
                
                const itemName = selected.dataset.name;
                const itemType = selected.dataset.type;
                const itemPrice = parseInt(selected.dataset.price);
                
                if (player.gold < itemPrice) {
                    addMessage(`❌ Not enough gold to buy ${itemName}!`);
                    return;
                }
                
                player.gold -= itemPrice;
                
                if (itemType === 'weapon') {
                    player.weapon = itemName;
                    addMessage(`⚔️ Purchased ${itemName}! Equipped as your weapon.`);
                    updateQuestProgress('buy', 'weapon');
                } else if (itemType === 'armor') {
                    player.armor = itemName;
                    addMessage(`🛡️ Purchased ${itemName}! Equipped as your armor.`);
                } else if (itemType === 'potion') {
                    if (!player.inventory[itemName]) player.inventory[itemName] = 0;
                    player.inventory[itemName]++;
                    addMessage(`🧪 Purchased ${itemName}! Added to your inventory.`);
                }
                
                updateUI();
                document.getElementById('shopUI').style.display = 'none';
                game.paused = false;
            };
        }
        
        function toggleQuestUI() {
            if (game.paused && document.getElementById('questUI').style.display === 'block') {
                document.getElementById('questUI').style.display = 'none';
                game.paused = false;
                return;
            }
            
            game.paused = true;
            document.getElementById('questUI').style.display = 'block';
            
            // Populate quest list
            const questList = document.getElementById('questList');
            questList.innerHTML = '';
            
            player.quests.forEach(quest => {
                const questItem = document.createElement('div');
                questItem.className = `quest-item ${quest.completed ? 'completed' : quest.progress > 0 ? 'active' : ''}`;
                
                let progressText = '';
                if (quest.objective.type === 'kill') {
                    const targetName = quest.objective.target === 'any' ? 'enemies' : `${quest.objective.target}s`;
                    progressText = `Defeated ${quest.progress}/${quest.objective.amount} ${targetName}`;
                } else if (quest.objective.type === 'chest') {
                    progressText = `Opened ${quest.progress}/${quest.objective.amount} chests`;
                } else if (quest.objective.type === 'buy') {
                    progressText = quest.progress > 0 ? 'Completed!' : 'Not started';
                }
                
                let rewardText = `Reward: ${quest.reward.gold} gold, ${quest.reward.exp} EXP`;
                if (quest.reward.item) {
                    rewardText += `, ${quest.reward.item}`;
                }
                
                questItem.innerHTML = `
                    <div class="quest-title">
                        ${quest.id}
                        <span class="quest-status ${quest.completed ? 'completed' : quest.progress > 0 ? 'active' : ''}">
                            ${quest.completed ? 'Completed' : quest.progress > 0 ? 'In Progress' : 'New'}
                        </span>
                    </div>
                    <div class="quest-desc">${quest.description}</div>
                    <div class="quest-progress">${progressText}</div>
                    <div class="quest-reward">${rewardText}</div>
                `;
                
                questList.appendChild(questItem);
            });
        }
        
        function updateQuestProgress(type, target) {
            player.quests.forEach(quest => {
                if (quest.completed) return;
                
                if (type === 'kill') {
                    if (quest.objective.type === 'kill' && 
                        (quest.objective.target === 'any' || quest.objective.target === target)) {
                        quest.progress++;
                        if (quest.progress >= quest.objective.amount) {
                            completeQuest(quest);
                        } else {
                            addMessage(`Quest Updated: ${quest.id} (${quest.progress}/${quest.objective.amount})`);
                        }
                    }
                } else if (type === 'chest' && quest.objective.type === 'chest') {
                    quest.progress++;
                    if (quest.progress >= quest.objective.amount) {
                        completeQuest(quest);
                    } else {
                        addMessage(`Quest Updated: ${quest.id} (${quest.progress}/${quest.objective.amount})`);
                    }
                } else if (type === 'buy' && quest.objective.type === 'buy' && quest.objective.itemType === target) {
                    quest.progress = 1;
                    completeQuest(quest);
                }
            });
        }
        
        function completeQuest(quest) {
            quest.completed = true;
            player.gold += quest.reward.gold;
            player.exp += quest.reward.exp;
            
            if (quest.reward.item) {
                if (!player.inventory[quest.reward.item]) player.inventory[quest.reward.item] = 0;
                player.inventory[quest.reward.item]++;
            }
            
            addMessage(`🎉 Quest Completed: ${quest.id}! Received ${quest.reward.gold} gold and ${quest.reward.exp} EXP${quest.reward.item ? ' and ' + quest.reward.item : ''}`);
            
            game.questsCompleted++;
            checkLevelUp();
            updateUI();
        }

        function attackNearbyEnemy() {
            if (player.inCombat || Date.now() - player.lastAttack < 1000 || game.paused) return;

            let nearestEnemy = null;
            let nearestDistance = Infinity;

            world.enemies.forEach(enemy => {
                if (!enemy.alive) return;
                
                const distance = Math.sqrt(
                    Math.pow(enemy.x - player.x, 2) + Math.pow(enemy.y - player.y, 2)
                );

                if (distance < 50 && distance < nearestDistance) {
                    nearestEnemy = enemy;
                    nearestDistance = distance;
                }
            });

            if (nearestEnemy) {
                startCombat(nearestEnemy);
            }
        }

        function startCombat(enemy) {
            if (player.inCombat) return;
            
            player.inCombat = true;
            player.combatTarget = enemy;
            
            document.getElementById('combatUI').style.display = 'block';
            document.getElementById('enemyName').textContent = enemy.name;
            document.getElementById('enemyHP').textContent = `${enemy.hp}/${enemy.maxHp}`;
            
            addMessage(`⚔️ Combat started with ${enemy.name}!`);
        }

        function combatAction(action) {
            if (!player.inCombat || !player.combatTarget) return;

            const enemy = player.combatTarget;

            switch (action) {
                case 'attack':
                    playerAttack(enemy);
                    break;
                case 'magic':
                    if (player.mp >= 15) {
                        playerMagic(enemy);
                    } else {
                        addMessage('❌ Not enough MP!');
                        return;
                    }
                    break;
                case 'item':
                    if (usePotion('Health Potion')) {
                        // Item used, continue to enemy turn
                    } else {
                        addMessage('❌ No Health Potions available!');
                        return;
                    }
                    break;
                case 'flee':
                    if (Math.random() < 0.3) {
                        addMessage('🏃 You successfully fled!');
                        endCombat();
                        return;
                    } else {
                        addMessage('❌ Could not escape!');
                    }
                    break;
            }

            // Enemy turn (if still alive)
            if (enemy.alive && enemy.hp > 0) {
                setTimeout(() => enemyAttack(enemy), 1000);
            }
        }

        function playerAttack(enemy) {
            const weaponBonus = weapons[player.weapon] ? weapons[player.weapon].attack : 0;
            const baseDamage = player.attack + weaponBonus;
            const damage = Math.max(1, baseDamage - enemy.defense + Math.floor(Math.random() * 11) - 5);
            enemy.hp -= damage;
            
            addMessage(`⚔️ You attack ${enemy.name} for ${damage} damage!`);
            showFloatingText(enemy.x, enemy.y, `-${damage}`, '#ff4444');
            
            if (enemy.hp <= 0) {
                enemyDefeated(enemy);
            } else {
                document.getElementById('enemyHP').textContent = `${enemy.hp}/${enemy.maxHp}`;
            }
            
            player.lastAttack = Date.now();
        }

        function playerMagic(enemy) {
            player.mp -= 15;
            const weaponBonus = weapons[player.weapon] ? weapons[player.weapon].attack : 0;
            const baseDamage = Math.floor(player.attack * 1.5) + weaponBonus;
            const damage = Math.max(1, baseDamage - enemy.defense + Math.floor(Math.random() * 8) - 3);
            enemy.hp -= damage;
            
            addMessage(`✨ You cast a spell on ${enemy.name} for ${damage} damage!`);
            showFloatingText(enemy.x, enemy.y, `-${damage}`, '#8a2be2');
            
            if (enemy.hp <= 0) {
                enemyDefeated(enemy);
            } else {
                document.getElementById('enemyHP').textContent = `${enemy.hp}/${enemy.maxHp}`;
            }
            
            updateUI();
        }

        function enemyAttack(enemy) {
            const armorBonus = armor[player.armor] ? armor[player.armor].defense : 0;
            const baseDefense = player.defense + armorBonus;
            const damage = Math.max(1, enemy.attack - baseDefense + Math.floor(Math.random() * 7) - 3);
            player.hp -= damage;
            
            addMessage(`💥 ${enemy.name} attacks you for ${damage} damage!`);
            showFloatingText(player.x, player.y, `-${damage}`, '#ff4444');
            
            if (player.hp <= 0) {
                gameOver();
            }
            
            updateUI();
        }

        function enemyDefeated(enemy) {
            enemy.alive = false;
            player.exp += enemy.exp;
            player.gold += enemy.gold;
            
            addMessage(`🎉 ${enemy.name} defeated! +${enemy.exp} EXP, +${enemy.gold} gold`);
            showFloatingText(enemy.x, enemy.y, `+${enemy.exp} EXP`, '#ffd700');
            
            game.enemiesDefeated++;
            updateQuestProgress('kill', enemy.type);
            checkLevelUp();
            endCombat();
            updateUI();
        }

        function endCombat() {
            player.inCombat = false;
            player.combatTarget = null;
            document.getElementById('combatUI').style.display = 'none';
        }

        function checkLevelUp() {
            if (player.exp >= player.expToNext) {
                player.level++;
                player.exp -= player.expToNext;
                player.expToNext = Math.floor(player.expToNext * 1.5);
                
                // Stat increases based on class
                const classStats = characterClasses[game.playerClass].stats;
                
                // Base stat increases
                const hpGain = 10 + Math.floor(Math.random() * 6);
                const mpGain = 5 + Math.floor(Math.random() * 4);
                const attackGain = 2 + Math.floor(Math.random() * 3);
                const defenseGain = 1 + Math.floor(Math.random() * 2);
                
                // Apply class bonuses
                player.maxHp += hpGain + Math.floor(classStats.maxHp * 0.05);
                player.maxMp += mpGain + Math.floor(classStats.maxMp * 0.05);
                player.attack += attackGain + Math.floor(classStats.attack * 0.05);
                player.defense += defenseGain + Math.floor(classStats.defense * 0.03);
                player.speed = classStats.speed;
                player.hp = player.maxHp; // Full heal
                player.mp = player.maxMp;
                
                showLevelUp(hpGain, mpGain, attackGain, defenseGain);
                addMessage(`🎉 LEVEL UP! You are now level ${player.level}!`);
                updateUI();
            }
        }

        function showLevelUp(hp, mp, attack, defense) {
            const levelUpDiv = document.getElementById('levelUpNotification');
            const levelUpText = document.getElementById('levelUpText');
            
            levelUpText.innerHTML = `
                Level ${player.level}!<br>
                HP +${hp}, MP +${mp}<br>
                Attack +${attack}, Defense +${defense}
            `;
            
            levelUpDiv.style.display = 'block';
            
            setTimeout(() => {
                levelUpDiv.style.display = 'none';
            }, 3000);
        }

        function usePotion(type) {
            if (!player.inventory[type] || player.inventory[type] <= 0) {
                return false;
            }

            if (type === 'Health Potion') {
                const heal = 30 + Math.floor(Math.random() * 21);
                const oldHp = player.hp;
                player.hp = Math.min(player.maxHp, player.hp + heal);
                const actualHeal = player.hp - oldHp;
                
                if (actualHeal > 0) {
                    addMessage(`🧪 Used Health Potion! Healed ${actualHeal} HP`);
                    showFloatingText(player.x, player.y, `+${actualHeal} HP`, '#44ff44');
                }
            } else if (type === 'Mana Potion') {
                const restore = 20 + Math.floor(Math.random() * 16);
                const oldMp = player.mp;
                player.mp = Math.min(player.maxMp, player.mp + restore);
                const actualRestore = player.mp - oldMp;
                
                if (actualRestore > 0) {
                    addMessage(`🔮 Used Mana Potion! Restored ${actualRestore} MP`);
                    showFloatingText(player.x, player.y, `+${actualRestore} MP`, '#4169e1');
                }
            }

            player.inventory[type]--;
            if (player.inventory[type] <= 0) {
                delete player.inventory[type];
            }

            updateUI();
            return true;
        }

        function showFloatingText(x, y, text, color) {
            if (!game.settings.showEffects) return;
            
            const textElement = document.createElement('div');
            textElement.textContent = text;
            textElement.className = color.includes('44') ? 'heal-text' : 'damage-text';
            textElement.style.color = color;
            textElement.style.left = (x - game.camera.x) + 'px';
            textElement.style.top = (y - game.camera.y) + 'px';
            
            document.body.appendChild(textElement);
            
            setTimeout(() => {
                textElement.classList.add('fade-up');
                setTimeout(() => {
                    if (textElement.parentNode) {
                        textElement.parentNode.removeChild(textElement);
                    }
                }, 1500);
            }, 100);
        }

        function gameOver() {
            addMessage('💀 GAME OVER! You have been defeated...');
            
            // Update game over screen stats
            document.getElementById('goLevel').textContent = player.level;
            document.getElementById('goGold').textContent = player.gold;
            document.getElementById('goEnemies').textContent = game.enemiesDefeated;
            document.getElementById('goQuests').textContent = game.questsCompleted;
            
            // Show game over screen
            document.getElementById('gameOverScreen').style.display = 'flex';
            game.paused = true;
        }
        
        function resetGame() {
            // Reset player stats
            player.x = 400;
            player.y = 300;
            player.hp = 100;
            player.maxHp = 100;
            player.mp = 50;
            player.maxMp = 50;
            player.level = 1;
            player.exp = 0;
            player.expToNext = 100;
            player.gold = 50;
            player.attack = 20;
            player.defense = 10;
            player.weapon = 'Rusty Sword';
            player.armor = 'Cloth Shirt';
            player.inventory = {
                'Health Potion': 3,
                'Mana Potion': 2
            };
            player.lastAttack = 0;
            player.inCombat = false;
            player.combatTarget = null;
            
            // Reset game stats
            game.enemiesDefeated = 0;
            game.questsCompleted = 0;
            game.gameTime = 0;
            
            // Reset camera
            game.camera = { x: 0, y: 0 };
            
            // Reset world
            world.currentArea = 'Forest Outskirts';
            world.items.forEach(item => item.collected = false);
            world.chests.forEach(chest => chest.opened = false);
            
            // Reset enemies
            generateEnemies();
            
            // Reset quests
            player.quests = [];
            for (const [id, quest] of Object.entries(quests)) {
                player.quests.push({ id, ...JSON.parse(JSON.stringify(quest)) });
            }
        }

        function addMessage(message) {
            const messageLog = document.getElementById('messageLog');
            const messageDiv = document.createElement('div');
            messageDiv.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            messageLog.appendChild(messageDiv);
            messageLog.scrollTop = messageLog.scrollHeight;

            // Keep only last 50 messages
            while (messageLog.children.length > 50) {
                messageLog.removeChild(messageLog.firstChild);
            }
        }

        function updateUI() {
            // Update player stats
            document.getElementById('playerName').textContent = game.playerName;
            document.getElementById('playerLevel').textContent = player.level;
            document.getElementById('playerClass').textContent = characterClasses[game.playerClass].name;
            document.getElementById('playerGold').textContent = player.gold;
            
            // Update bars
            const hpPercent = (player.hp / player.maxHp) * 100;
            const mpPercent = (player.mp / player.maxMp) * 100;
            const expPercent = (player.exp / player.expToNext) * 100;
            
            document.getElementById('hpBar').style.width = hpPercent + '%';
            document.getElementById('mpBar').style.width = mpPercent + '%';
            document.getElementById('expBar').style.width = expPercent + '%';
            
            document.getElementById('hpText').textContent = `${player.hp}/${player.maxHp} HP`;
            document.getElementById('mpText').textContent = `${player.mp}/${player.maxMp} MP`;
            document.getElementById('expText').textContent = `${player.exp}/${player.expToNext} EXP`;
            
            // Update equipment
            document.getElementById('weaponName').textContent = player.weapon;
            document.getElementById('armorName').textContent = player.armor;
            document.getElementById('attackStat').textContent = player.attack + (weapons[player.weapon] ? weapons[player.weapon].attack : 0);
            document.getElementById('defenseStat').textContent = player.defense + (armor[player.armor] ? armor[player.armor].defense : 0);
            
            // Update inventory
            const inventoryList = document.getElementById('inventoryList');
            inventoryList.innerHTML = '';
            
            for (let [item, quantity] of Object.entries(player.inventory)) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                
                const icon = document.createElement('div');
                icon.className = 'item-icon';
                icon.textContent = item.includes('Potion') ? '🧪' : item.includes('Sword') ? '⚔️' : item.includes('Armor') ? '🛡️' : '✨';
                
                const name = document.createElement('div');
                name.className = 'item-name';
                name.textContent = item;
                
                const qty = document.createElement('div');
                qty.className = 'item-quantity';
                qty.textContent = `x${quantity}`;
                
                itemDiv.appendChild(icon);
                itemDiv.appendChild(name);
                itemDiv.appendChild(qty);
                
                itemDiv.onclick = () => {
                    if (item.includes('Potion')) {
                        usePotion(item);
                    } else {
                        addMessage(`ℹ️ ${item} must be equipped at a shop`);
                    }
                };
                
                inventoryList.appendChild(itemDiv);
            }
            
            if (Object.keys(player.inventory).length === 0) {
                inventoryList.innerHTML = '<div style="color: #888; font-style: italic;">Empty</div>';
            }
        }

        // Rendering functions
        function render() {
            // Clear main canvas
            game.ctx.fillStyle = '#2d5016';
            game.ctx.fillRect(0, 0, game.canvas.width, game.canvas.height);

            // Draw grass pattern (only for higher quality settings)
            if (game.settings.graphicsQuality !== 'low') {
                game.ctx.fillStyle = '#3d6b1a';
                for (let x = 0; x < game.canvas.width; x += 40) {
                    for (let y = 0; y < game.canvas.height; y += 40) {
                        if ((x + y) % 80 === 0) {
                            game.ctx.fillRect(x, y, 20, 20);
                        }
                    }
                }
            }

            // Draw world objects
            drawTrees();
            drawRocks();
            drawItems();
            drawChests();
            drawShops();
            drawEnemies();
            drawPlayer();
            
            // Draw area boundaries
            drawAreaBoundaries();

            // Draw minimap
            if (game.showMinimap) {
                drawMinimap();
            }
        }

        function drawTrees() {
            world.trees.forEach(tree => {
                const screenX = tree.x - game.camera.x;
                const screenY = tree.y - game.camera.y;
                
                if (screenX > -tree.size && screenX < game.canvas.width + tree.size &&
                    screenY > -tree.size && screenY < game.canvas.height + tree.size) {
                    
                    // Tree trunk
                    game.ctx.fillStyle = '#8B4513';
                    game.ctx.fillRect(screenX + tree.size * 0.4, screenY + tree.size * 0.7, tree.size * 0.2, tree.size * 0.3);
                    
                    // Tree foliage
                    game.ctx.fillStyle = '#228B22';
                    game.ctx.beginPath();
                    game.ctx.arc(screenX + tree.size * 0.5, screenY + tree.size * 0.4, tree.size * 0.4, 0, Math.PI * 2);
                    game.ctx.fill();
                    
                    // Tree shadow
                    game.ctx.fillStyle = 'rgba(0,0,0,0.2)';
                    game.ctx.beginPath();
                    game.ctx.ellipse(screenX + tree.size * 0.5, screenY + tree.size, tree.size * 0.3, tree.size * 0.1, 0, 0, Math.PI * 2);
                    game.ctx.fill();
                }
            });
        }

        function drawRocks() {
            world.rocks.forEach(rock => {
                const screenX = rock.x - game.camera.x;
                const screenY = rock.y - game.camera.y;
                
                if (screenX > -rock.size && screenX < game.canvas.width + rock.size &&
                    screenY > -rock.size && screenY < game.canvas.height + rock.size) {
                    
                    game.ctx.fillStyle = '#696969';
                    game.ctx.beginPath();
                    game.ctx.arc(screenX + rock.size * 0.5, screenY + rock.size * 0.5, rock.size * 0.4, 0, Math.PI * 2);
                    game.ctx.fill();
                    
                    // Rock highlight
                    game.ctx.fillStyle = '#A9A9A9';
                    game.ctx.beginPath();
                    game.ctx.arc(screenX + rock.size * 0.4, screenY + rock.size * 0.4, rock.size * 0.15, 0, Math.PI * 2);
                    game.ctx.fill();
                }
            });
        }

        function drawItems() {
            world.items.forEach(item => {
                if (item.collected) return;
                
                const screenX = item.x - game.camera.x;
                const screenY = item.y - game.camera.y;
                
                if (screenX > -20 && screenX < game.canvas.width + 20 &&
                    screenY > -20 && screenY < game.canvas.height + 20) {
                    
                    if (item.type === 'gold') {
                        game.ctx.fillStyle = '#FFD700';
                        game.ctx.beginPath();
                        game.ctx.arc(screenX, screenY, 8, 0, Math.PI * 2);
                        game.ctx.fill();
                        
                        game.ctx.fillStyle = '#FFA500';
                        game.ctx.beginPath();
                        game.ctx.arc(screenX - 2, screenY - 2, 3, 0, Math.PI * 2);
                        game.ctx.fill();
                    } else {
                        game.ctx.fillStyle = '#FF69B4';
                        game.ctx.fillRect(screenX - 6, screenY - 8, 12, 16);
                        
                        game.ctx.fillStyle = '#8B008B';
                        game.ctx.fillRect(screenX - 4, screenY - 2, 8, 8);
                    }
                }
            });
        }
        
        function drawChests() {
            world.chests.forEach(chest => {
                if (chest.opened) return;
                
                const screenX = chest.x - game.camera.x;
                const screenY = chest.y - game.camera.y;
                
                if (screenX > -30 && screenX < game.canvas.width + 30 &&
                    screenY > -30 && screenY < game.canvas.height + 30) {
                    
                    // Chest base
                    game.ctx.fillStyle = '#8B4513';
                    game.ctx.fillRect(screenX, screenY + 10, 30, 20);
                    
                    // Chest top
                    game.ctx.fillStyle = '#A0522D';
                    game.ctx.fillRect(screenX, screenY, 30, 10);
                    
                    // Chest details
                    game.ctx.fillStyle = '#FFD700';
                    game.ctx.fillRect(screenX + 5, screenY + 3, 20, 4);
                    game.ctx.fillRect(screenX + 13, screenY + 13, 4, 8);
                    
                    // Chest highlight
                    if (Math.abs(chest.x - player.x) < 50 && Math.abs(chest.y - player.y) < 50) {
                        game.ctx.strokeStyle = '#FFD700';
                        game.ctx.lineWidth = 2;
                        game.ctx.strokeRect(screenX - 2, screenY - 2, 34, 34);
                    }
                }
            });
        }
        
        function drawShops() {
            world.shops.forEach(shop => {
                const screenX = shop.x - game.camera.x;
                const screenY = shop.y - game.camera.y;
                
                if (screenX > -shop.width && screenX < game.canvas.width + shop.width &&
                    screenY > -shop.height && screenY < game.canvas.height + shop.height) {
                    
                    // Shop building
                    game.ctx.fillStyle = '#8B4513';
                    game.ctx.fillRect(screenX, screenY, shop.width, shop.height);
                    
                    // Shop roof
                    game.ctx.fillStyle = '#A0522D';
                    game.ctx.beginPath();
                    game.ctx.moveTo(screenX - 5, screenY);
                    game.ctx.lineTo(screenX + shop.width/2, screenY - 15);
                    game.ctx.lineTo(screenX + shop.width + 5, screenY);
                    game.ctx.closePath();
                    game.ctx.fill();
                    
                    // Shop sign
                    game.ctx.fillStyle = '#FFD700';
                    game.ctx.fillRect(screenX + shop.width/2 - 10, screenY - 25, 20, 10);
                    game.ctx.fillStyle = '#000';
                    game.ctx.font = 'bold 10px Arial';
                    game.ctx.textAlign = 'center';
                    game.ctx.fillText('SHOP', screenX + shop.width/2, screenY - 18);
                    game.ctx.textAlign = 'left';
                    
                    // Shop highlight
                    if (Math.abs(shop.x + shop.width/2 - player.x) < 60 && 
                        Math.abs(shop.y + shop.height/2 - player.y) < 60) {
                        game.ctx.strokeStyle = '#FFD700';
                        game.ctx.lineWidth = 2;
                        game.ctx.strokeRect(screenX - 5, screenY - 5, shop.width + 10, shop.height + 10);
                    }
                }
            });
        }

        function drawEnemies() {
            world.enemies.forEach(enemy => {
                if (!enemy.alive) return;
                
                const screenX = enemy.x - game.camera.x;
                const screenY = enemy.y - game.camera.y;
                
                if (screenX > -enemy.width && screenX < game.canvas.width + enemy.width &&
                    screenY > -enemy.height && screenY < game.canvas.height + enemy.height) {
                    
                    // Enemy body
                    game.ctx.fillStyle = enemy.color;
                    game.ctx.fillRect(screenX, screenY, enemy.width, enemy.height);
                    
                    // Enemy eyes
                    game.ctx.fillStyle = '#FF0000';
                    game.ctx.fillRect(screenX + 5, screenY + 5, 4, 4);
                    game.ctx.fillRect(screenX + 16, screenY + 5, 4, 4);
                    
                    // Health bar above enemy
                    const hpBarWidth = 30;
                    const hpBarHeight = 4;
                    const hpPercent = enemy.hp / enemy.maxHp;
                    
                    game.ctx.fillStyle = '#333';
                    game.ctx.fillRect(screenX - 2, screenY - 10, hpBarWidth, hpBarHeight);
                    
                    game.ctx.fillStyle = hpPercent > 0.5 ? '#00FF00' : hpPercent > 0.25 ? '#FFFF00' : '#FF0000';
                    game.ctx.fillRect(screenX - 2, screenY - 10, hpBarWidth * hpPercent, hpBarHeight);
                    
                    // Chasing indicator
                    if (enemy.chasing) {
                        game.ctx.fillStyle = '#FF0000';
                        game.ctx.font = '12px Arial';
                        game.ctx.fillText('!', screenX + enemy.width + 5, screenY + 10);
                    }
                }
            });
        }

        function drawPlayer() {
            const screenX = player.x - game.camera.x;
            const screenY = player.y - game.camera.y;
            
            // Player shadow
            game.ctx.fillStyle = 'rgba(0,0,0,0.3)';
            game.ctx.beginPath();
            game.ctx.ellipse(screenX + player.width * 0.5, screenY + player.height + 2, player.width * 0.4, player.height * 0.1, 0, 0, Math.PI * 2);
            game.ctx.fill();
            
            // Player body
            game.ctx.fillStyle = characterClasses[game.playerClass].color;
            game.ctx.fillRect(screenX, screenY, player.width, player.height);
            
            // Player face
            game.ctx.fillStyle = '#FFE4B5';
            game.ctx.fillRect(screenX + 5, screenY + 5, 20, 15);
            
            // Player eyes
            game.ctx.fillStyle = '#000';
            game.ctx.fillRect(screenX + 8, screenY + 8, 2, 2);
            game.ctx.fillRect(screenX + 18, screenY + 8, 2, 2);
            
            // Player weapon
            game.ctx.fillStyle = '#C0C0C0';
            if (game.playerClass === 'warrior' || game.playerClass === 'rogue') {
                game.ctx.fillRect(screenX + 25, screenY + 10, 8, 2);
                game.ctx.fillRect(screenX + 30, screenY + 5, 2, 12);
            } else if (game.playerClass === 'ranger') {
                game.ctx.beginPath();
                game.ctx.moveTo(screenX + 25, screenY + 15);
                game.ctx.lineTo(screenX + 35, screenY + 5);
                game.ctx.lineTo(screenX + 35, screenY + 10);
                game.ctx.closePath();
                game.ctx.fill();
            } else if (game.playerClass === 'mage') {
                game.ctx.beginPath();
                game.ctx.arc(screenX + 30, screenY + 10, 5, 0, Math.PI * 2);
                game.ctx.fill();
                game.ctx.fillStyle = '#4169E1';
                game.ctx.beginPath();
                game.ctx.arc(screenX + 30, screenY + 10, 3, 0, Math.PI * 2);
                game.ctx.fill();
            }
            
            // Level indicator
            game.ctx.fillStyle = '#FFD700';
            game.ctx.font = 'bold 12px Arial';
            game.ctx.fillText(player.level.toString(), screenX + player.width + 5, screenY - 2);
        }

        function drawAreaBoundaries() {
            game.ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            game.ctx.lineWidth = 2;
            game.ctx.setLineDash([5, 5]);
            
            for (let [areaName, area] of Object.entries(world.areas)) {
                const screenX = area.x - game.camera.x;
                const screenY = area.y - game.camera.y;
                
                game.ctx.strokeRect(screenX, screenY, area.width, area.height);
                
                // Area name
                game.ctx.fillStyle = 'rgba(255,255,255,0.8)';
                game.ctx.font = 'bold 16px Arial';
                game.ctx.fillText(areaName, screenX + 10, screenY + 25);
            }
            
            game.ctx.setLineDash([]);
        }

        function drawMinimap() {
            const minimapScale = 0.1;
            
            // Clear minimap
            game.minimapCtx.fillStyle = '#2d5016';
            game.minimapCtx.fillRect(0, 0, 150, 150);
            
            // Draw world bounds
            game.minimapCtx.strokeStyle = '#fff';
            game.minimapCtx.lineWidth = 1;
            game.minimapCtx.strokeRect(0, 0, world.width * minimapScale, world.height * minimapScale);
            
            // Draw areas
            game.minimapCtx.strokeStyle = 'rgba(255,255,255,0.5)';
            for (let area of Object.values(world.areas)) {
                game.minimapCtx.strokeRect(
                    area.x * minimapScale,
                    area.y * minimapScale,
                    area.width * minimapScale,
                    area.height * minimapScale
                );
            }
            
            // Draw enemies
            game.minimapCtx.fillStyle = '#FF0000';
            world.enemies.forEach(enemy => {
                if (enemy.alive) {
                    game.minimapCtx.fillRect(
                        enemy.x * minimapScale - 1,
                        enemy.y * minimapScale - 1,
                        2, 2
                    );
                }
            });
            
            // Draw items
            game.minimapCtx.fillStyle = '#FFD700';
            world.items.forEach(item => {
                if (!item.collected) {
                    game.minimapCtx.fillRect(
                        item.x * minimapScale - 0.5,
                        item.y * minimapScale - 0.5,
                        1, 1
                    );
                }
            });
            
            // Draw chests
            game.minimapCtx.fillStyle = '#8B4513';
            world.chests.forEach(chest => {
                if (!chest.opened) {
                    game.minimapCtx.fillRect(
                        chest.x * minimapScale - 1,
                        chest.y * minimapScale - 1,
                        2, 2
                    );
                }
            });
            
            // Draw shops
            game.minimapCtx.fillStyle = '#FFD700';
            world.shops.forEach(shop => {
                game.minimapCtx.fillRect(
                    shop.x * minimapScale - 1,
                    shop.y * minimapScale - 1,
                    2, 2
                );
            });
            
            // Draw player
            game.minimapCtx.fillStyle = characterClasses[game.playerClass].color;
            game.minimapCtx.fillRect(
                player.x * minimapScale - 2,
                player.y * minimapScale - 2,
                4, 4
            );
            
            // Draw view area
            game.minimapCtx.strokeStyle = '#4a90e2';
            game.minimapCtx.lineWidth = 1;
            game.minimapCtx.strokeRect(
                game.camera.x * minimapScale,
                game.camera.y * minimapScale,
                game.canvas.width * minimapScale,
                game.canvas.height * minimapScale
            );
        }

        // Main game loop
        function gameLoop(currentTime) {
            if (!game.running) return;
            
            const deltaTime = currentTime - game.lastTime;
            game.lastTime = currentTime;
            
            // Update game logic
            updatePlayer(deltaTime);
            updateEnemies(deltaTime);
            
            // Render everything
            render();
            
            requestAnimationFrame(gameLoop);
        }

        // Initialize and start game
        function startGame() {
            console.log('🎮 Starting 2D Fantasy RPG...');
            
            // Set player stats based on class
            const classStats = characterClasses[game.playerClass].stats;
            player.hp = classStats.hp;
            player.maxHp = classStats.maxHp;
            player.mp = classStats.mp;
            player.maxMp = classStats.maxMp;
            player.attack = classStats.attack;
            player.defense = classStats.defense;
            player.speed = classStats.speed;
            player.color = characterClasses[game.playerClass].color;
            
            // Initialize world
            initWorld();
            updateUI();
            
            // Show welcome messages
            addMessage(`🌟 Welcome to the Fantasy RPG Adventure, ${game.playerName}!`);
            addMessage(`🏆 You are a ${characterClasses[game.playerClass].name}`);
            addMessage('🎯 Use WASD to move, Space to attack, I for potions');
            addMessage('📍 Click on enemies to start combat or press Space');
            addMessage('🗺️ Press M to toggle minimap, Q for quests, S for shop');
            
            // Show initial quest
            addMessage(`📜 New Quest: ${player.quests[0].id} - ${player.quests[0].description}`);
            
            // Show game container
            document.getElementById('gameContainer').style.display = 'flex';
            
            // Start the game loop
            requestAnimationFrame(gameLoop);
        }

        // Start the game when page loads
        window.addEventListener('load', () => {
            // Load settings from localStorage
            const savedSettings = localStorage.getItem('gameSettings');
            if (savedSettings) {
                game.settings = JSON.parse(savedSettings);
            }
            
            // Show main menu
            document.getElementById('mainMenu').style.display = 'flex';
        });
    </script>
</body>
</html>
